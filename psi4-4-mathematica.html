<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Required meta tags always come first -->
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>
Psi4 4 Mathematica |         b3m2a1

</title>
  <link rel="canonical" href="https://www.wolframcloud.com/objects/b3m2a1/home/psi4-4-mathematica.html">

  <link rel="alternate" type="application/atom+xml" href="https://www.wolframcloud.com/objects/b3m2a1/home/feeds/all.atom.xml" title="Full Atom Feed">

  <link rel="apple-touch-icon" href="https://www.wolframcloud.com/objects/b3m2a1/home/apple-touch-icon.png" sizes="180x180">
  <link rel="icon" type="image/png" href="https://www.wolframcloud.com/objects/b3m2a1/home/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="https://www.wolframcloud.com/objects/b3m2a1/home/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="https://www.wolframcloud.com/objects/b3m2a1/home/manifest.json">
  <meta name="theme-color" content="#333333">

  <link rel="stylesheet" href="https://www.wolframcloud.com/objects/b3m2a1/home/theme/css/bootstrap.css">
  <link rel="stylesheet" href="https://www.wolframcloud.com/objects/b3m2a1/home/theme/css/font-awesome.css">
  <link rel="stylesheet" href="https://www.wolframcloud.com/objects/b3m2a1/home/theme/css/style.css">


<meta name="description" content="We’ll return to doing fake chemistry , but this time we’ll work with something that very real chemists have built, namely the open-source quantum chemistry package Psi4 the package itself is voluminous, doing many things I don’t understand and never really will, but it does do some things …">

<link href="https://www.wolframcloud.com/objects/b3m2a1/home/theme/prettify/styles/prettify-mma.min.css" rel="stylesheet">
<script src="https://www.wolframcloud.com/objects/b3m2a1/home/theme/prettify/src/prettify.js"></script>
<!-- <script src="https://www.wolframcloud.com/objects/b3m2a1/home/theme/prettify/src/lang-mma.min.js"></script> -->

<script>
  function moveWindow (){window.location.hash="main-content";}
</script>


<script>
  (function(i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function() {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o);
    a.async = 1;
    a.src = g;
    m = s.getElementsByTagName(o)[0];
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'UA-103560228-1', 'auto');
  ga('send', 'pageview');
</script>

  <script>
    function openNav() {
      var thumb = document.getElementById("nav-thumb");
      var bar = document.getElementById("side-nav");
      thumb.onclick= closeNav;
      bar.classList.add("right-bar-open");
      bar.classList.remove("right-bar-closed");
      thumb.classList.add("nav-thumb-open");
      thumb.classList.remove("nav-thumb-closed");
    }

    function closeNav() {
      var thumb = document.getElementById("nav-thumb");
      var bar = document.getElementById("side-nav");
      thumb.onclick= openNav;
      bar.classList.remove("right-bar-open");
      bar.classList.add("right-bar-closed");
      thumb.classList.remove("nav-thumb-open");
      thumb.classList.add("nav-thumb-closed")
    }
  </script>


</head>

<body onload="PR.prettyPrint(); moveWindow()"
>
  <header class="header">
    <div class="top-bar">
    <div class="site-image">
      <img src=https://www.wolframcloud.com/objects/b3m2a1/home/img/site-image.png alt="b3m2a1">
    </div>
    <div class="site-links bubble floating">
      <h1 class="title">
          <a href="https://www.wolframcloud.com/objects/b3m2a1/home/">
            b3m2a1
          </a>
        </h1>
        <ul
          class="list-inline row site-link-row"
          id="top-bar-link-row"
          >
            <li class="list-inline-item site-link">
              <a href="https://www.wolframcloud.com/objects/b3m2a1/home/pages/about.html">About</a>
            </li>
            <li class="list-inline-item site-link">
              <a href="https://www.wolframcloud.com/objects/b3m2a1/home/pages/contact.html">Contact</a>
            </li>
            <li class="list-inline-item site-link">
              <a href="https://www.wolframcloud.com/objects/b3m2a1/home/categories.html">Categories</a>
            </li>
            <li class="list-inline-item site-link">
              <a href="https://www.wolframcloud.com/objects/b3m2a1/home/tags.html">Tags</a>
            </li>
            <li class="list-inline-item site-link">
              <a href="https://www.wolframcloud.com/objects/b3m2a1/home/archives.html">Archives</a>
            </li>
        </ul>
    </div>
    </div>
  </header>

  <div class="main" id="main-content">

    <div class="right-bar right-bar-closed" id="side-nav">
      <button
        id="nav-thumb"
        class="nav-thumb nav-thumb-closed"
        onclick="openNav()"
        >
      </button>
      <div class="blogroll bubble inset">
        <p>Links</p>
        <ul class="blogroll-links right-bar-links list-inline">
            <li class="right-bar-item">
              <a href="https://github.com/b3m2a1" class="blogroll-link right-bar-link"
                target="_blank">
                GitHub
              </a>
            </li>
            <li class="right-bar-item">
              <a href="https://mathematica.stackexchange.com/users/38205" class="blogroll-link right-bar-link"
                target="_blank">
                StackExchange
              </a>
            </li>
            <li class="right-bar-item">
              <a href="https://www.wolframcloud.com/objects/b3m2a1.paclets/PacletServer/main.html" class="blogroll-link right-bar-link"
                target="_blank">
                Paclets
              </a>
            </li>
            <li class="right-bar-item">
              <a href="https://www.wolframcloud.com/objects/b3m2a1.docs/DocumentationSite/main.html" class="blogroll-link right-bar-link"
                target="_blank">
                Docs
              </a>
            </li>
          </ul>
      </div>
    </div>

    <div class="left-content">
      <div class="container">
        <h1>Psi4 4 Mathematica
</h1>
        <hr>
<article class="article">
  <header>
    <ul class="list-inline">
      <li class="list-inline-item text-muted" title="2017-07-29T02:57:18-05:00">
        <i class="fa fa-clock-o"></i>
        Sat 29 July 2017
      </li>
      <li class="list-inline-item">
        <i class="fa fa-folder-open-o"></i>
        <a href="https://www.wolframcloud.com/objects/b3m2a1/home/category/posts.html">posts</a>
      </li>
      <li class="list-inline-item">
        <i class="fa fa-user-o"></i>
        <a href="https://www.wolframcloud.com/objects/b3m2a1/home/author/b3m2a1.html">b3m2a1</a>      </li>
      <li class="list-inline-item">
        <i class="fa fa-files-o"></i>
        <a href="https://www.wolframcloud.com/objects/b3m2a1/home/tag/mathematica.html">#mathematica</a>,         <a href="https://www.wolframcloud.com/objects/b3m2a1/home/tag/psi4.html">#psi4</a>      </li>
    </ul>
  </header>
  <div class="content">
    <p>We’ll return to doing  <a href="https://www.wolframcloud.com/objects/b3m2a1/home/-pretend-chemistry-and-fake-objects.html#main-content">fake chemistry</a> , but this time we’ll work with something that very real chemists have built, namely the open-source quantum chemistry package  <a href="http://www.psicode.org/">Psi4</a>  the package itself is voluminous, doing many things I don’t understand and never really will, but it does do some things that every chemist knows and many use or at the minimum enjoy looking at--molecular orbitals and electric potentials. </p>
<p>Here's a taste of the sort of thing we're talking about:</p>
<pre class="prettyprint"><code>AtomsetOrbitalsPlot[trifluoromethlyoxirane,
  &quot;Orbitals&quot; -&gt; {5},
  &quot;Mode&quot; -&gt; &quot;Cached&quot;
  ]

(*Out:*)</code></pre>


<p><img alt="posts-psi4-4-mathematica-2540855987582776301" src="https://www.wolframcloud.com/objects/b3m2a1/home/img/posts-psi4-4-mathematica-2540855987582776301.png" /></p>
<p>This is the 5th molecular orbital of  <a href="http://www.chemspider.com/Chemical-Structure.454245.html">trifluoromethyl-oxirane</a> , more or less, plotted as a  <a href="https://reference.wolfram.com/language/ref/ContourPlot3D.html"><code>ContourPlot3D</code></a>  (with stylistic choices taken from  <a href="http://community.wolfram.com/groups/-/m/t/131302?sortMsg=Votes">Jason Biggs</a> ) in Mathematica. Note that things are slightly askew -- the lobes and the reference molecule don’t perfectly align, but this is a pretty reasonable orbital, all told. So first let’s break down how this was made, starting with the easiest bits (if you just want the Psi4 integration bits go  <a href="#psi4's-the-1-4-me">here</a> ):</p>
<p><a id="making-trifluoromethyl-oxirane" >&zwnj;</a></p>
<h2>Making Trifluoromethyl oxirane</h2>
<p>Generally when I play around with this stuff I do it by using stuff I can directly import–-and I did test this code using importable cases—but, for interest sake, I thought I’d try working with a system I knew about but wasn’t importable.</p>
<p>On the other hand it’s mostly importable:</p>
<pre class="prettyprint"><code>ChemImport[methyloxirane] // ChemView

(*Out:*)</code></pre>


<p><img alt="posts-psi4-4-mathematica-1585593140277608260" src="https://www.wolframcloud.com/objects/b3m2a1/home/img/posts-psi4-4-mathematica-1585593140277608260.png" /></p>
<p>And so we only have to do, say, two things:</p>
<ul>
<li>
<p>Replace the methyl hydrogens with fluorines</p>
</li>
<li>
<p>Renormalize those bonds</p>
</li>
</ul>
<p>And we could do this in a lazy sort of way, say:</p>
<ul>
<li>
<p>Find the hydrogens</p>
</li>
<li>
<p>Remove the hydrogens</p>
</li>
<li>
<p>Create 3 fluorines</p>
</li>
<li>
<p>Move the fluorines in, rebond, etc.</p>
</li>
<li>
<p>Calculate fluorine bond vectors, move them along the vector back into place</p>
</li>
</ul>
<p>But this is a lot of work for just trifluoromethly-oxirane and this sort of operation is just generally pretty useful, so we’ll functionalize it in three chunks:</p>
<ul>
<li>
<p>Atom selection by type (e.g. methyl hydrogen)</p>
</li>
<li>
<p>Atom substitution</p>
</li>
<li>
<p>Atomset bond normalization</p>
</li>
</ul>
<h3>Atom Selection</h3>
<p>This is a more interesting problem in general, really, than just the case of methyl groups, as it can be generalized pretty easily to any group with a core atom. We can basically think of specifying such a group as the following:</p>
<pre class="prettyprint"><code>&lt;|
  &quot;Core&quot; -&gt; type,
  &quot;Bonds&quot; -&gt; {
     &lt;|&quot;Element&quot; -&gt; el1, &quot;Type&quot; -&gt; type1|&gt;,
     &lt;|&quot;Element&quot; -&gt; el2, &quot;Type&quot; -&gt; type2|&gt;,
     ...,
     &lt;|&quot;Element&quot; -&gt; eln, &quot;Type&quot; -&gt; typen|&gt;
     }
  |&gt;</code></pre>


<p>Or more compactly:</p>
<pre class="prettyprint"><code>type -&gt;
  {
    el1 -&gt; type1,
    el2 -&gt; type2,
    ...,
    eln -&gt; typen
    }</code></pre>


<p>And then a methyl group is just:</p>
<pre class="prettyprint"><code>&quot;C&quot; -&gt;
  {
    &quot;H&quot; -&gt; 1,
    &quot;H&quot; -&gt; 1,
    &quot;H&quot; -&gt; 1,
    _
    }</code></pre>


<p>Since we can (and in fact should) write this to leverage Mathematica’s pattern specifications / matching. And one last thing we’ll find very useful is the ability to add a selection specification to what we’ll take. We’ll let this be a general pattern that will match against the atom type. So for our methyl hydrogens:</p>
<pre class="prettyprint"><code>&quot;C&quot; -&gt;
  {
     &quot;H&quot; -&gt; 1,
     &quot;H&quot; -&gt; 1,
     &quot;H&quot; -&gt; 1,
     _
     } -&gt; &quot;H&quot;</code></pre>


<p>Simple enough to specify. Now the implementation isn’t too bad, the primary difficulty is to do it in a chunked fashion. Essentially pull in all the data at the beginning rather than at each loop step. The full implementation isn’t worth putting here, but you can find it under  <code>AtomsetAtomMemberQ</code>  in  <a href="https://github.com/b3m2a1/mathematica-ChemTools/blob/master/Packages/Objects.m">Objects.m</a>  essentially after all that we can select atoms that are members of groups in atomsets and there are a few cooked in. What’s relevant right now is how this works for methyl hydrogens:</p>
<pre class="prettyprint"><code>AtomsetGetAtoms[methyloxirane, &quot;Methyl&quot; -&gt; &quot;H&quot;] // ChemView

(*Out:*)</code></pre>


<p><img alt="posts-psi4-4-mathematica-4100392340054740369" src="https://www.wolframcloud.com/objects/b3m2a1/home/img/posts-psi4-4-mathematica-4100392340054740369.png" /></p>
<p>Basically the  <code>"Methyl"</code>  says, “find atoms in methly groups” and the  <code>"H"</code>  says only take the hydrogens from that group. And lo and behold it works. On to part 2.</p>
<h3>Atom Substitution</h3>
<p>This is honestly the easiest part of the whole deal. It’s almost as straightforward as can be, easy to vectorize, etc. The basic part is to set the positions of the new atoms to those of the old atoms:</p>
<pre class="prettyprint"><code> AtomsetRemoveAtom[obj, old];
 AtomsetAddAtom[obj, new];
 pos = ChemGet[old, &quot;Position&quot;];
 ChemThreadSet[new, &quot;Position&quot;, pos];</code></pre>


<p>Then do the bonds:</p>
<pre class="prettyprint"><code>BondBreak /@ DeleteDuplicates@Flatten@bonds;
types = ChemGet[bonds, &quot;Type&quot;];
atoms =
   Replace[
     ChemGet[bonds, &quot;Atoms&quot;],
     ({Alternatives @@ old, a_} | {a_, Alternatives @@ old}) :&gt; a,
     {2}
     ];</code></pre>


<p>And just  <a href="https://reference.wolfram.com/language/ref/MapThread.html"><code>MapThread</code></a>  a mapped  <a href="https://www.wolframcloud.com/objects/b3m2a1.paclets/reference/ChemTools/ref/AtomCreateBond.html"><code>AtomCreateBond</code></a>  over that.</p>
<h3>Bond Normalization</h3>
<p>This is the fun part. First of we need a concept of what the “standard” distance is for all these bond types. I’ve accumulated a number of those, by statistically going through PubChem and averaging over bond types. This is integrated into  <a href="https://www.wolframcloud.com/objects/b3m2a1.paclets/reference/ChemTools/ref/ChemDataLookup.html"><code>ChemDataLookup</code></a> .</p>
<pre class="prettyprint"><code>ChemDataLookup[ChemDataQuery[&quot;C&quot;, &quot;F&quot;], &quot;BondDistances&quot;]

(*Out:*)

1.34782</code></pre>


<p>Where these distances should be  <a href="https://reference.wolfram.com/language/ref/Quantity.html"><code>Quantity</code></a>  expressions with units  <code>"Angstroms"</code> . But I’m lazy and that adds a mild inefficiency. So we’ll let that be our standard. Note that if there wasn’t a distance in the sample I used we’re screwed:</p>
<pre class="prettyprint"><code>ChemDataLookup[ChemDataQuery[&quot;Ne&quot;, &quot;F&quot;], &quot;BondDistances&quot;]

(*Out:*)

-1.</code></pre>


<p>Also some of these are slightly odd:</p>
<pre class="prettyprint"><code>ChemDataLookup[ChemDataQuery[&quot;S&quot;, &quot;F&quot;], &quot;BondDistances&quot;]

(*Out:*)

1.19224</code></pre>


<p>But for common cases things are okay. And this data will be updated periodically when time permits.</p>
<pre class="prettyprint"><code>ChemDataLookup[
  {
    ChemDataQuery[&quot;C&quot;, &quot;H&quot;],
    ChemDataQuery[&quot;C&quot;, &quot;O&quot;],
    ChemDataQuery[&quot;C&quot;, &quot;N&quot;],
    ChemDataQuery[&quot;C&quot;, &quot;C&quot;],
    ChemDataQuery[&quot;C&quot;, &quot;C&quot;, 2],
    ChemDataQuery[&quot;C&quot;, &quot;C&quot;, 3]
    },
  &quot;BondDistances&quot;
  ]

(*Out:*)

{1.02348, 1.29987, 1.42094, 1.42432, 1.35593, 1.2004}</code></pre>


<p>So that’s our normalization. Now we have to figure out what needs to be normalized. We’ll do this by comparing against a tolerance set by the  <a href="https://reference.wolfram.com/language/ref/AccuracyGoal.html"><code>AccuracyGoal</code></a>  option, where anything whose bond length deviates from the standard by more than that gets normalized.</p>
<p>And now here’s the interesting part. If we, say, normalize any of the C-C bonds in methyl-oxirane that will screw up all sorts of other bonds. In effect, we need to move one “side” of the bond by the amount of deviation. Where each “side” is really the collection of connected atoms that don’t use the bond. A good example of what I mean is in the documentation for  <a href="https://www.wolframcloud.com/objects/b3m2a1.paclets/reference/ChemTools/ref/AtomsetConnectedComponents.html"><code>AtomsetConnectedComponents</code></a> .</p>
<p>We’ll do this by building an  <a href="https://www.wolframcloud.com/objects/b3m2a1.paclets/reference/ChemTools/ref/AtomGraph.html"><code>AtomGraph</code></a>  of all the atoms in the atomset, taking the edges, and then for each bond we normalize dropping the edge corresponding to it. Then use a simple  <a href="https://reference.wolfram.com/language/ref/ConnectedComponents.html"><code>ConnectedComponents</code></a>  on that to find our “sides”. Of course, one corner case arises here. Consider this:</p>
<pre class="prettyprint"><code>Graph[
  {
    1 &lt;-&gt; 2,
    2 &lt;-&gt; 3,
    3 &lt;-&gt; 4
    }
  ]

(*Out:*)</code></pre>


<p><img alt="posts-psi4-4-mathematica-5611763199457359583" src="https://www.wolframcloud.com/objects/b3m2a1/home/img/posts-psi4-4-mathematica-5611763199457359583.png" /></p>
<p>Now drop the  <code>1 &lt;-&gt; 2</code>  bond:</p>
<pre class="prettyprint"><code>Graph[
   {
     2 &lt;-&gt; 3,
     3 &lt;-&gt; 4
     }
   ] // ConnectedComponents

(*Out:*)

{{2, 3, 4}}</code></pre>


<p>We’ve lost the knowledge about 1. So we need an explicit check for that at each loop-step. But otherwise we just need to determine which side is which by figuring out which chunk contains the first atom in the bond.</p>
<p>Then just move each side equally and in opposite directions so that the tolerance is dealt with.</p>
<p>Note, of course, that there are some structures, notably ringed structures, for which this method will not suffice. But for most small-molecules, like trifluoromethly-oxirane, this will. </p>
<p>Now for a demonstration:</p>
<pre class="prettyprint"><code>ChemImport[pentane];
AtomsetTransform[pentane, ScalingTransform[{1, 1, 3}]];
pentane // ChemView

(*Out:*)</code></pre>


<p><img alt="posts-psi4-4-mathematica-8444149889600703777" src="https://www.wolframcloud.com/objects/b3m2a1/home/img/posts-psi4-4-mathematica-8444149889600703777.png" /></p>
<pre class="prettyprint"><code>AtomsetNormalizeBonds[pentane]
pentane // ChemView

(*Out:*)</code></pre>


<p><img alt="posts-psi4-4-mathematica-7791321167466445589" src="https://www.wolframcloud.com/objects/b3m2a1/home/img/posts-psi4-4-mathematica-7791321167466445589.png" /></p>
<p>And now checking the bond deviations:</p>
<pre class="prettyprint"><code>BondDeviation@Values@AtomsetBonds[pentane]

(*Out:*)

{0., 0., 2.22045*10^-16, 
 2.22045*10^-16, 0.0963753, -6.66134*10^-16, -4.44089*10^-16, \
0.096458, -6.66134*10^-16, 2.22045*10^-16, 
 1.77636*10^-15, -1.55431*10^-15, 0.0718594, 
 1.77636*10^-15, 0.0717659, 4.44089*10^-16}</code></pre>


<p>They’re mostly all 0, except for 4 of them, and we can see which those are:</p>
<pre class="prettyprint"><code>Pick[
     #,
     # &gt; .01 &amp; /@ Abs[BondDeviation[#]]
     ] &amp;@Values@AtomsetBonds[pentane] // ChemView

(*Out:*)</code></pre>


<p><img alt="posts-psi4-4-mathematica-1788405745229544950" src="https://www.wolframcloud.com/objects/b3m2a1/home/img/posts-psi4-4-mathematica-1788405745229544950.png" /></p>
<p>And those are bonds that are in the plane of the chain, and so were likely unscaled by the  <code>ScalingTransform</code> . That the other two bonds were caught up could be an effect of the odd C-C bond distance I have in my core data, too.</p>
<h3>Making a trifluoromethly-oxirane</h3>
<p>And finally with that in place, build and substitute:</p>
<pre class="prettyprint"><code>trifluoromethlyoxirane = ChemImport[&quot;methyloxirane&quot;];
subs = Table[CreateAtom[&quot;F&quot;], 3];
AtomsetSubstituteAtom[
   trifluoromethlyoxirane,
   Thread[
     AtomsetGetAtoms[trifluoromethlyoxirane, &quot;Methyl&quot; -&gt; &quot;H&quot;] -&gt;
      subs
     ]
   ];
tfgraphic = trifluoromethlyoxirane // ChemView

(*Out:*)</code></pre>


<p><img alt="posts-psi4-4-mathematica-5463542750916706943" src="https://www.wolframcloud.com/objects/b3m2a1/home/img/posts-psi4-4-mathematica-5463542750916706943.png" /></p>
<p>And renormalize:</p>
<pre class="prettyprint"><code>subbonds =
   DeleteDuplicates@
     Flatten@
       ChemGet[
         AtomsetGetAtoms[trifluoromethlyoxirane,
           &quot;C&quot; -&gt; { &quot;F&quot; -&gt; _, &quot;F&quot; -&gt; _, &quot;F&quot; -&gt; _, _ } -&gt; &quot;F&quot;
           ], 
         &quot;Bonds&quot;
         ];
AtomsetNormalizeBonds[
   trifluoromethlyoxirane,
   subbonds
   ];
Show[trifluoromethlyoxirane // ChemView, tfgraphic]

(*Out:*)</code></pre>


<p><img alt="posts-psi4-4-mathematica-2554271558397266408" src="https://www.wolframcloud.com/objects/b3m2a1/home/img/posts-psi4-4-mathematica-2554271558397266408.png" /></p>
<p>And of course we can easily do the same for, say, tribromomethyl-oxirane, which doesn’t seem to have a Chem Spider page:</p>
<pre class="prettyprint"><code>tbmo = ChemImport[&quot;methyloxirane&quot;];
subel = &quot;Br&quot;;
subs = Table[CreateAtom[subel], 3];
AtomsetSubstituteAtom[
   tbmo,
   Thread[
     AtomsetGetAtoms[tbmo, &quot;Methyl&quot; -&gt; &quot;H&quot;] -&gt;
      subs
     ]
   ];
subbonds =
   DeleteDuplicates@
     Flatten@
       ChemGet[
         AtomsetGetAtoms[subel,
           &quot;C&quot; -&gt; { subel -&gt; _, subel -&gt; _, subel -&gt; _, _ } -&gt; subel
           ], 
         &quot;Bonds&quot;
         ];
AtomsetNormalizeBonds[
   tbmo,
   subbonds
   ];
tbmo // ChemView

(*Out:*)</code></pre>


<p><img alt="posts-psi4-4-mathematica-67328113050823263" src="https://www.wolframcloud.com/objects/b3m2a1/home/img/posts-psi4-4-mathematica-67328113050823263.png" /></p>
<p>Or on anything with a methyl group.</p>
<p><a id="psi4's-the-1-4-me" >&zwnj;</a></p>
<h2>Psi4’s The 1 4 me</h2>
<p>One of the many nice features of Psi4 is that it’s implemented in C++ rather than Fortran, so not only is the code easily readable to anyone with a decent grounding in modern programming languages ( Java, python, JavaScript, any other C-flavored language). Moreover, that makes it possible to use with  <a href="http://reference.wolfram.com/language/guide/LibraryLink.html.en">Library Link</a>  if one so desired. This I did not do. Instead I decided to build a symbolic python system to use with Psi4’s  <a href="http://www.psicode.org/psi4manual/master/psithoninput.html">Psithon</a>  interpreter. The vagaries of this system are convoluted and not worth going into here. Here’s just a quick example of what it provides:</p>
<pre class="prettyprint"><code>Needs[&quot;ChemTools`SymbolicPython`&quot;];
sympy =
  ToSymbolicPython[
    Map[f, Range[100]]
    ]

(*Out:*)

PyList[PyMap[&quot;f&quot;, PyRange[100]]]</code></pre>


<p>And we can build this out like so:</p>
<pre class="prettyprint"><code>sympy // ToPython

(*Out:*)

&quot;list(map(f, range(100)))&quot;</code></pre>


<p>The symbolic layer is useful as a transform and whatnot, and is also a cleaner syntax to write templates in than strings. And it can be used for OpenBabel too.</p>
<p>So with that in hand we can actually get around to writing stuff to play with Psi4</p>
<h3>CubeProp</h3>
<p>Psi4 has a module that implements calculations that dump to a Gaussian cube file called  <a href="http://www.psicode.org/psi4manual/master/cubeprop.html">cubeprop</a>  it’s pretty straightforward and most cubeprop calls have a similar set-up. So we’ll mirror that in our template code and build out a general purpose function called  <code>Psi4CubeProperty</code>  to implement this transformation.</p>
<pre class="prettyprint"><code>psi4In = Psi4CubeProperty[&lt;|&quot;Molecules&quot; -&gt; {{&quot;O&quot;}}|&gt;]

(*Out:*)</code></pre>


<p><img alt="posts-psi4-4-mathematica-2501598204267374743" src="https://www.wolframcloud.com/objects/b3m2a1/home/img/posts-psi4-4-mathematica-2501598204267374743.png" /></p>
<p>It generates an input file to push through psithon:</p>
<pre class="prettyprint"><code>psi4In[&quot;input.dat&quot;]

(*Out:*)

&quot;#Sat 29 Jul 2017 02:13:19\n#Cube prop call\nmolecule monomer {\n\tO \
0. 0. 0.\n\tnoreorient\n\tnocom\n\t}\nset {\n\tbasis cc-pvdz\n\t\
scf_type df\n\tcubeprop_tasks orbitals\n\tcubeprop_orbitals [ 1 ]\n\t\
}\n[ E, wfn ] = energy('scf', return_wfn=True)\ncubeprop(wfn)&quot;</code></pre>


<p>So that’s cool. And then we implement layers on that function for specific useful tasks. For example here’s the code that builds out an orbitals call.</p>
<pre class="prettyprint"><code>Options[Psi4CubeOrbitals] = Options@Psi4CubeProperty;
Psi4CubeOrbitals[a_Association] :=
   Psi4CubeProperty@
     Merge[{
        Append[a,

      &quot;Configuration&quot; -&gt;

       Merge[{Lookup[a, &quot;Configuration&quot;, &lt;||&gt;],
               &lt;|
                 &quot;CubePropTasks&quot; -&gt; {&quot;orbitals&quot;},

          &quot;CubePropOrbitals&quot; -&gt; {1, -1, 2, -2, 3, -3, 4, -4, 5, -5}
                 |&gt;
               },
              First]
          ],
        &quot;Output&quot; -&gt; &quot;Psi_*.cube&quot;
        },
       First];
Psi4CubeOrbitals[atomList_List, orbitals : {__Integer} : {1}, 
   p : (_Rule | _RuleDelayed) ...] :=
   Psi4CubeOrbitals@
     &lt;|
       &quot;Molecules&quot; -&gt; atomList,
       &quot;CubePropOrbitals&quot; -&gt; orbitals,
       p
       |&gt;;
Psi4CubeOrbitals[atomList_List, orbitals_Integer, 
  p : (_Rule | _RuleDelayed) ...] :=

 Psi4CubeOrbitals[atomList, Join[#, -#] &amp;@Range[orbitals]]</code></pre>


<p>The options handling gets a bit convoluted, but otherwise it’s really very standard. And then we build a layer on the atomset side to call Psi4 to get these orbitals:</p>
<pre class="prettyprint"><code>AtomsetOrbitalsPlot[
  trifluoromethlyoxirane,
  &quot;Orbitals&quot; -&gt; {1},
  &quot;Mode&quot; -&gt; 
  &quot;Cached&quot; (* tells the system to save the computed orbital functions \
*)
  ]

(*Out:*)</code></pre>


<p><img alt="posts-psi4-4-mathematica-8285460256702348359" src="https://www.wolframcloud.com/objects/b3m2a1/home/img/posts-psi4-4-mathematica-8285460256702348359.png" /></p>
<p>And this can, of course, be configured for arbitrary set ups.</p>
<h3>Cube Files</h3>
<p>One complication does arise, though, in that we need a way to handle Gaussian cube files. So I wrote a collection of  <code>CubeFile*</code>  functions that handle most of this dirty work. For each cube file what actually gets pushed through to the end is an  <a href="https://reference.wolfram.com/language/ref/InterpolatingFunction.html"><code>InterpolatingFunction</code></a>  over the cube, so we could actually do funky things like this:</p>
<pre class="prettyprint"><code>oneminustwo =
   With[{orbs =
       Values@
         AtomsetOrbitals[
           trifluoromethlyoxirane,
           &quot;Orbitals&quot; -&gt; 2,
           &quot;Mode&quot; -&gt; &quot;Cached&quot;
           ]
      },
     Compile[{{p, _Real, 1}},
       orbs[[1]][p] -
         orbs[[2]][p]
       ]
     ];
AtomsetOrbitalsPlot[
  trifluoromethlyoxirane,
  {oneminustwo}
  ]

(*Out:*)</code></pre>


<p><img alt="posts-psi4-4-mathematica-7843640030057352736" src="https://www.wolframcloud.com/objects/b3m2a1/home/img/posts-psi4-4-mathematica-7843640030057352736.png" /></p>
<p>Which is the subtraction of two orbitals. This is obviously just a basic example, but there is power in being able to work with these orbitals as the functions that they are.</p>
<p>Alternatively we can do this plot as a  <code>ListDensityPlot3D</code> :</p>
<pre class="prettyprint"><code>AtomsetOrbitalsPlot[
   trifluoromethlyoxirane,
   {oneminustwo},
   &quot;PlotFunction&quot; -&gt; &quot;Density&quot;
   ] // Rasterize(*to speed up rendering since we don't need to \
manipulate it*)

(*Out:*)</code></pre>


<p><img alt="posts-psi4-4-mathematica-6108137519702443272" src="https://www.wolframcloud.com/objects/b3m2a1/home/img/posts-psi4-4-mathematica-6108137519702443272.png" /></p>
<p>And it’s harder to see exactly what’s happening. But we can see the two super localized blobs near those two fluorines.</p>
<h3>Electric Potentials</h3>
<p>Psi4 exposes a lot more than just the cubeprop module, but most of that will have to wait for another post (and likely some more development on my side). One final fun thing to look at, though, is comparing electric potentials across similar.</p>
<p>We can start with the first-approximation Gasteiger version:</p>
<pre class="prettyprint"><code>AtomsetElectricPotentialMap[#, &quot;Mode&quot; -&gt; &quot;Gasteiger&quot;] &amp; /@ {
    methyloxirane,
    trifluoromethlyoxirane,
    tbmo
    } // GraphicsRow

(*Out:*)</code></pre>


<p><img alt="posts-psi4-4-mathematica-3139807658775850902" src="https://www.wolframcloud.com/objects/b3m2a1/home/img/posts-psi4-4-mathematica-3139807658775850902.png" /></p>
<p>It’s a bit small, but we can see pretty clearly that it’s doing a decent job. All of that seems reasonable. But let’s just see what the real version looks like:</p>
<pre class="prettyprint"><code>AtomsetElectricPotentialMap[#, &quot;Mode&quot; -&gt; &quot;Psi4&quot;] &amp; /@ {
    methyloxirane,
    trifluoromethlyoxirane,
    tbmo
    } // GraphicsRow

(*Out:*)</code></pre>


<p><img alt="posts-psi4-4-mathematica-7974393243239400710" src="https://www.wolframcloud.com/objects/b3m2a1/home/img/posts-psi4-4-mathematica-7974393243239400710.png" /></p>
<p>It takes a lot longer, but the quality of the result is better. This is an electric potential we can actually start to work with. And, in fact, since we have it as an  <code>InterpolatingFunction</code>  we easily could manipulate these potentials and compare them on a point-by-point basis.</p>
<p>But for now we’ll leave things as they are and come back to Psi4 another day.</p>
  </div>
</article>
<hr>
<div id="disqus_thread"></div>
<script>
  var disqus_config = function() {
    this.page.url = 'https://www.wolframcloud.com/objects/b3m2a1/home/psi4-4-mathematica.html';
      this.page.identifier = 'b3m2a1-home-9d02889c-bef6-4c6b-957d-f2bcb2914334';
;
  };
  (function() {
    var d = document;
    var s = d.createElement('script');
    s.src = '//b3m2a1-home.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript class="text-muted">
  Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
      </div>
    </div>

  </div>

  <footer class="footer">
    <p class="col-sm-6 text-sm-right text-muted acknowledgement">
      Generated by
      <a href="https://github.com/getpelican/pelican" target="_blank">Pelican</a> /
      Forked from <a href="https://github.com/nairobilug/pelican-alchemy" target="_blank">alchemy</a>
    </p>
  </footer>

</body>

</html>